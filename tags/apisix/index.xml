<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Apisix on Rogee's 备忘录</title><link>http://notes.711xd.com/tags/apisix/</link><description>Recent content in Apisix on Rogee's 备忘录</description><generator>Hugo -- gohugo.io</generator><language>en</language><copyright>Rogee</copyright><lastBuildDate>Fri, 26 Nov 2021 16:32:00 +0800</lastBuildDate><atom:link href="http://notes.711xd.com/tags/apisix/index.xml" rel="self" type="application/rss+xml"/><item><title>Apisix 配置 HTTPS SNI 不识别问题定位</title><link>http://notes.711xd.com/post/apisix-https-sni-error/</link><pubDate>Fri, 26 Nov 2021 16:32:00 +0800</pubDate><guid>http://notes.711xd.com/post/apisix-https-sni-error/</guid><description>&lt;p>ApiSIX网关&lt;/p>
&lt;h2 id="问题说明">问题说明&lt;/h2>
&lt;p>项目中配置 HTTPS 需要支持 IP 格式直接访问，Apisix 中配置证书需要使用到 SNI 识别功能，但是使用 IP 方式请求主机时 SNI 识别为空，导致配置的 SNI 证书无法被匹配。&lt;/p>
&lt;h2 id="问题定位">问题定位&lt;/h2>
&lt;p>根据报错信息来定位代码逻辑部分：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="mi">2021&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">20&lt;/span> &lt;span class="mi">09&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">54&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">33&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">error&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="mi">42&lt;/span>&lt;span class="o">#&lt;/span>&lt;span class="mi">42&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="mi">2011&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">lua&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">init.lua&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">184&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">http_ssl_phase&lt;/span>&lt;span class="p">():&lt;/span> &lt;span class="n">failed&lt;/span> &lt;span class="n">to&lt;/span> &lt;span class="n">fetch&lt;/span> &lt;span class="n">ssl&lt;/span> &lt;span class="n">config&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">failed&lt;/span> &lt;span class="n">to&lt;/span> &lt;span class="n">find&lt;/span> &lt;span class="n">SNI&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">please&lt;/span> &lt;span class="n">check&lt;/span> &lt;span class="kr">if&lt;/span> &lt;span class="n">the&lt;/span> &lt;span class="n">client&lt;/span> &lt;span class="n">reques&lt;/span>
&lt;span class="n">If&lt;/span> &lt;span class="n">you&lt;/span> &lt;span class="n">need&lt;/span> &lt;span class="n">to&lt;/span> &lt;span class="n">report&lt;/span> &lt;span class="n">an&lt;/span> &lt;span class="n">issue&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">provide&lt;/span> &lt;span class="n">a&lt;/span> &lt;span class="n">packet&lt;/span> &lt;span class="n">capture&lt;/span> &lt;span class="n">file&lt;/span> &lt;span class="n">of&lt;/span> &lt;span class="n">the&lt;/span> &lt;span class="n">TLS&lt;/span> &lt;span class="n">handshake&lt;/span>&lt;span class="p">.,&lt;/span> &lt;span class="n">context&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">ssl_certificate_by_lua&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">client&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mf">172.17.0.1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">server&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mf">0.0.0.0&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">6443&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item></channel></rss>